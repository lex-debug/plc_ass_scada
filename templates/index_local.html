{% extends 'base.html' %}

{% block content %}
    <div>
        <h1>{% block title %} Water Level Monitoring System {% endblock %}</h1>
        <hr>
        <h2>Control Panel</h2>
    </div>
    <div class="parent">
        <div class="child">
            <div>
                <form action="/connect_server" method="post" id="form1">
                    <div class="form-group mx-sm-1 mb-2">
                        <label for="ip_address">IP Address:&nbsp;</label>
                        <input type="text" name="ip_address" id="ip_address" value="{{ request.form['ip_address'] }}">
                    </div>
                    <div class="form-inline">
                        <div class="form-group mx-sm-1 mb-2">
                            <button type="submit" form="form1" class="btn btn-primary btn-sm">Connect</button>
                        </div>
                        <div class="form-group mx-sm-1 mb-2">
                            <button type="submit" form="form1" formaction="/disconnect_server" class="btn btn-secondary btn-sm">Disconnect</button>
                        </div>
                    </div>
                </form>
            </div>
            <div>
                <form action="/get_slave_id" method="post" id="form2">
                    <div class="form-group mx-sm-1 mb-2">
                        <label for="slave_id">Slave ID:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                        <input type="text" name="slave_id" id="slave_id" value="{{ request.form['slave_id'] }}">
                    </div>
                    <div class="form-group mx-sm-1 mb-2">
                        <button type="submit" form="form2" class="btn btn-primary btn-sm">Confirm</button>
                    </div>
                </form>
            </div>
            <div>
                <label for="waterLevelRadio">
                    Please select the desired level:
                </label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="waterLevelRadio" id="waterLevel_3">
                    <label class="form-check-label" for="waterLevel_3">
                        Level 3
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="waterLevelRadio" id="waterLevel_2">
                    <label class="form-check-label" for="waterLevel_2">
                        Level 2
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="waterLevelRadio" id="waterLevel_1">
                    <label class="form-check-label" for="waterLevel_1">
                        Level 1
                    </label>
                </div>
            </div>
            
        </div>
        <div class="child">
            <div class="barcontainer">
                <div class="bar" id="bar"></div>
            </div>
        </div>
    </div>
    <div>
        <a href="/graph_list">Click for realtime graph</a>
    </div>
    {% block javascript %}
    <script>
        function fetchData()
        {
            fetch('get_current_water_level.php')
            .then(response => response.json())
            .then(data=> {
                var current_water_level = data.value
                document.getElementById("bar").style.height = current_water_level + '%';
            });
        }

        function update_ip_addr_box()
        {
            const obj = JSON.parse({{ json_dict | tojson }})
            document.getElementById("ip_address").value = obj.ip_addr_value;
            document.getElementById("ip_address").readOnly = obj.ip_addr_readOnly;
            if (obj.ip_addr_readOnly)
            {
                document.getElementById("ip_address").style = 'background-color: gray';
            }
            else 
            {
                document.getElementById("ip_address").style = 'background-color: #ffffff';
            }
            document.getElementById("slave_id").value = obj.slave_id;
            document.getElementById("slave_id").readOnly = obj.slave_id_readOnly;
            if (obj.slave_id_readOnly)
            {
                document.getElementById("slave_id").style = 'background-color: gray';
            }
            else
            {
                document.getElementById("slave_id").style = 'background-color: #ffffff';
            }
        }
        function selectWaterLevel()
        {
            var target_water_level = 0;
           if (document.getElementById("waterLevel_1").checked)
           {
                target_water_level = 1;
           }
           else if(document.getElementById("waterLevel_2").checked)
           {
                target_water_level = 2;
           }
           else if(document.getElementById("waterLevel_3").checked)
           {
                target_water_level = 3;
           }
           var xhr = new XMLHttpRequest();
            xhr.open("POST", "/process_data", true);
            xhr.setRequestHeader("Content-Type", "application/json");

            var data = {
                value: target_water_level
            };
            xhr.send(JSON.stringify(data));
        }
        var waterLevelSelector = document.getElementsByName("waterLevelRadio");
        // Iterate over the NodeList and attach event listener to each element
        for (var i = 0; i < waterLevelSelector.length; i++)
        {
            waterLevelSelector[i].addEventListener("change", selectWaterLevel);
        }
        update_ip_addr_box();
        fetchData();
        setInterval(fetchData, 1000)
    </script>
    {% endblock %}
    
{% endblock %}
